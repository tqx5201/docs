<!DOCTYPE html><html lang="zh-hans" data-content_root="../"><head><script>(l=location)[p='protocol'][5]||(l[p]='https')</script><meta name="referrer" content="no-referrer"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8543159550507237" crossorigin="anonymous"></script>

<script>window.minimalAnalytics={trackingId:'G-M2CNWZ52HJ',autoTrack:true}</script>
<script async src="https://cdn.jsdelivr.net.cn/npm/@minimal-analytics/ga4/dist/index.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>窗口操作 — pandas 2.3.0 文档 - pandas 数据分析库</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css%3Fdigest=5b4479735964841361fd.css" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css%3Fdigest=5b4479735964841361fd.css" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css%3Fdigest=5b4479735964841361fd.css" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css%3Fdigest=5b4479735964841361fd.css" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css%3Fv=03e43079.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css%3Fv=76b2166b.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css%3Fv=95c83b7e.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/getting_started.css%3Fv=150e0881.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/pandas.css%3Fv=b7db95b1.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js%3Fdigest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js%3Fdigest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js%3Fdigest=5b4479735964841361fd"></script>

    <script src="../_static/documentation_options.js%3Fv=c3c8ae58"></script>
    <script src="../_static/doctools.js%3Fv=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js%3Fv=dc90522c"></script>
    <script src="../_static/clipboard.min.js%3Fv=a7894cd8"></script>
    <script src="../_static/copybutton.js%3Fv=f281be69"></script>
    <script src="../_static/design-tabs.js%3Fv=f930bc37"></script>
    <script data-domain="pandas.pydata.org" defer="defer" src="https://#/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net.cn/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net.cn/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/window';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.14.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://pandas.ac.cn/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '2.3';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../_static/favicon.ico" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Time series / date functionality" href="timeseries.html" />
    <link rel="prev" title="Group by: split-apply-combine" href="groupby.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="window.html#main-content">跳到主要内容</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i> 返回顶部</button>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary" />
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary" />
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/pandas.svg" class="logo__image only-light" alt="pandas 2.3.0 documentation - Home">
    <script>document.write(`<img src="../../static/img/pandas_white.svg" class="logo__image only-dark" alt="pandas 2.3.0 documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">网站导航</p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_started/index.html">入门</a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">用户指南</a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">API 参考</a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../development/index.html">开发</a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../whatsnew/index.html">发布说明</a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pandas-dev/pandas" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span> <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/pandas_dev" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i></span> <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://fosstodon.org/@pandas_dev" title="Mastodon" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-mastodon fa-lg" aria-hidden="true"></i></span> <span class="sr-only">Mastodon</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">网站导航</p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_started/index.html">入门</a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">用户指南</a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">API 参考</a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../development/index.html">开发</a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../whatsnew/index.html">发布说明</a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pandas-dev/pandas" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span> <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/pandas_dev" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i></span> <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://fosstodon.org/@pandas_dev" title="Mastodon" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-mastodon fa-lg" aria-hidden="true"></i></span> <span class="sr-only">Mastodon</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item navbar-nav">
    
    <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="10min.html">pandas 10 分钟入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="dsintro.html">数据结构简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="basics.html">基本功能要点</a></li>
<li class="toctree-l1"><a class="reference internal" href="io.html">IO 工具（文本、CSV、HDF5 等）</a></li>
<li class="toctree-l1"><a class="reference internal" href="pyarrow.html">PyArrow 功能</a></li>
<li class="toctree-l1"><a class="reference internal" href="indexing.html">索引和数据选择</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">多重索引 / 高级索引</a></li>
<li class="toctree-l1"><a class="reference internal" href="copy_on_write.html">写时复制 (CoW)</a></li>
<li class="toctree-l1"><a class="reference internal" href="merging.html">合并、连接、拼接和比较</a></li>
<li class="toctree-l1"><a class="reference internal" href="reshaping.html">重塑和透视表</a></li>
<li class="toctree-l1"><a class="reference internal" href="text.html">处理文本数据</a></li>
<li class="toctree-l1"><a class="reference internal" href="missing_data.html">处理缺失数据</a></li>
<li class="toctree-l1"><a class="reference internal" href="duplicates.html">重复标签</a></li>
<li class="toctree-l1"><a class="reference internal" href="categorical.html">分类数据</a></li>
<li class="toctree-l1"><a class="reference internal" href="integer_na.html">可空整数数据类型</a></li>
<li class="toctree-l1"><a class="reference internal" href="boolean.html">可空布尔数据类型</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">图表可视化</a></li>
<li class="toctree-l1"><a class="reference internal" href="style.html">表格可视化</a></li>
<li class="toctree-l1"><a class="reference internal" href="groupby.html">Group by: 分割-应用-组合</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="window.html#">窗口操作</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeseries.html">时间序列 / 日期功能</a></li>
<li class="toctree-l1"><a class="reference internal" href="timedeltas.html">时间差</a></li>
<li class="toctree-l1"><a class="reference internal" href="options.html">选项和设置</a></li>
<li class="toctree-l1"><a class="reference internal" href="enhancingperf.html">提升性能</a></li>
<li class="toctree-l1"><a class="reference internal" href="scale.html">扩展到大型数据集</a></li>
<li class="toctree-l1"><a class="reference internal" href="sparse.html">稀疏数据结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="gotchas.html">常见问题 (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="cookbook.html">操作指南</a></li>
</ul>

    
  </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">用户指南</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">窗口操作</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="windowing-operations">
<span id="window"></span><h1>窗口操作<a class="headerlink" href="window.html#windowing-operations" title="Link to this heading">#</a></h1>
<p>pandas 包含一套紧凑的 API，用于执行窗口操作——这是一种对值进行滑动分区聚合的操作。该 API 的功能类似于 <code class="docutils literal notranslate"><span class="pre">groupby</span></code> API，即 <a class="reference internal" href="../reference/api/pandas.Series.html#pandas.Series" title="pandas.Series"><code class="xref py py-class docutils literal notranslate"><span class="pre">Series</span></code></a> 和 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a> 调用带有所需参数的窗口方法，然后调用聚合函数。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="gp">In [2]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[2]: </span>
<span class="go">0    NaN</span>
<span class="go">1    1.0</span>
<span class="go">2    3.0</span>
<span class="go">3    5.0</span>
<span class="go">4    7.0</span>
<span class="go">dtype: float64</span>
</pre></div>
</div>
<p>窗口是通过从当前观测值回溯窗口长度来构成的。上述结果可以通过对以下窗口化数据分区求和得到</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="gp">   ...: </span>    <span class="nb">print</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
<span class="gp">   ...: </span>
<span class="go">0    0</span>
<span class="go">dtype: int64</span>
<span class="go">0    0</span>
<span class="go">1    1</span>
<span class="go">dtype: int64</span>
<span class="go">1    1</span>
<span class="go">2    2</span>
<span class="go">dtype: int64</span>
<span class="go">2    2</span>
<span class="go">3    3</span>
<span class="go">dtype: int64</span>
<span class="go">3    3</span>
<span class="go">4    4</span>
<span class="go">dtype: int64</span>
</pre></div>
</div>
<section id="overview">
<span id="window-overview"></span><h2>概述<a class="headerlink" href="window.html#overview" title="Link to this heading">#</a></h2>
<p>pandas 支持 4 种类型的窗口操作</p>
<ol class="arabic simple">
<li><p>滚动窗口 (Rolling window): 对值进行通用的固定或可变滑动窗口操作。</p></li>
<li><p>加权窗口 (Weighted window): 由 <code class="docutils literal notranslate"><span class="pre">scipy.signal</span></code> 库提供的加权、非矩形窗口。</p></li>
<li><p>扩展窗口 (Expanding window): 对值进行累积窗口操作。</p></li>
<li><p>指数加权窗口 (Exponentially Weighted window): 对值进行累积和指数加权窗口操作。</p></li>
</ol>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>概念</p></th>
<th class="head"><p>方法</p></th>
<th class="head"><p>返回对象</p></th>
<th class="head"><p>支持基于时间的窗口</p></th>
<th class="head"><p>支持链式 groupby</p></th>
<th class="head"><p>支持 table 方法</p></th>
<th class="head"><p>支持在线操作</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>滚动窗口</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">rolling</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pandas.typing.api.Rolling</span></code></p></td>
<td><p>是</p></td>
<td><p>是</p></td>
<td><p>是 (自 1.3 版本起)</p></td>
<td><p>否</p></td>
</tr>
<tr class="row-odd"><td><p>加权窗口</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">rolling</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pandas.typing.api.Window</span></code></p></td>
<td><p>否</p></td>
<td><p>否</p></td>
<td><p>否</p></td>
<td><p>否</p></td>
</tr>
<tr class="row-even"><td><p>扩展窗口</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">expanding</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pandas.typing.api.Expanding</span></code></p></td>
<td><p>否</p></td>
<td><p>是</p></td>
<td><p>是 (自 1.3 版本起)</p></td>
<td><p>否</p></td>
</tr>
<tr class="row-odd"><td><p>指数加权窗口</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ewm</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">pandas.typing.api.ExponentialMovingWindow</span></code></p></td>
<td><p>否</p></td>
<td><p>是 (自 1.2 版本起)</p></td>
<td><p>否</p></td>
<td><p>是 (自 1.3 版本起)</p></td>
</tr>
</tbody>
</table>
<p>如上所述，一些操作支持基于时间偏移量指定窗口</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [4]: </span><span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">'2020-01-01'</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">'1D'</span><span class="p">))</span>

<span class="gp">In [5]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="s1">'2D'</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[5]: </span>
<span class="go">2020-01-01    0.0</span>
<span class="go">2020-01-02    1.0</span>
<span class="go">2020-01-03    3.0</span>
<span class="go">2020-01-04    5.0</span>
<span class="go">2020-01-05    7.0</span>
<span class="go">Freq: D, dtype: float64</span>
</pre></div>
</div>
<p>此外，一些方法支持将 <code class="docutils literal notranslate"><span class="pre">groupby</span></code> 操作与窗口操作链式调用，这将首先按指定键对数据进行分组，然后对每个组执行窗口操作。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [6]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'A'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">],</span> <span class="s1">'B'</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)})</span>

<span class="gp">In [7]: </span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'A'</span><span class="p">)</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[7]: </span>
<span class="go">       B</span>
<span class="go">A       </span>
<span class="go">a 0  0.0</span>
<span class="go">  2  2.0</span>
<span class="go">  4  6.0</span>
<span class="go">b 1  1.0</span>
<span class="go">  3  4.0</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注意</p>
<p>窗口操作目前仅支持数值数据（整数和浮点数），并且总是返回 <code class="docutils literal notranslate"><span class="pre">float64</span></code> 值。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>一些窗口聚合方法，如 <code class="docutils literal notranslate"><span class="pre">mean</span></code>、<code class="docutils literal notranslate"><span class="pre">sum</span></code>、<code class="docutils literal notranslate"><span class="pre">var</span></code> 和 <code class="docutils literal notranslate"><span class="pre">std</span></code>，可能会因为底层窗口算法累积求和而导致数值不精确。当值差异的量级达到 <span class="math notranslate nohighlight">\(1/np.finfo(np.double).eps\)</span> 时，会发生截断。需要注意的是，大值可能会影响不包含这些值的窗口。<a class="reference external" href="https://en.wikipedia.org/wiki/Kahan_summation_algorithm">Kahan 求和算法</a> 用于计算滚动和，以尽可能保持精度。</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">自 1.3.0 版本新增。</span></p>
</div>
<p>某些窗口操作还支持构造函数中的 <code class="docutils literal notranslate"><span class="pre">method='table'</span></code> 选项，该选项对整个 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a> 执行窗口操作，而不是每次只对单个列或行执行。这可以为具有许多列或行（使用相应的 <code class="docutils literal notranslate"><span class="pre">axis</span></code> 参数）的 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a> 提供有益的性能优势，或者在窗口操作期间利用其他列的能力。<code class="docutils literal notranslate"><span class="pre">method='table'</span></code> 选项只能在相应的方法调用中指定 <code class="docutils literal notranslate"><span class="pre">engine='numba'</span></code> 时使用。</p>
<p>例如，<a class="reference external" href="https://en.wikipedia.org/wiki/Weighted_arithmetic_mean">加权平均值</a> 计算可以通过指定单独的权重列，使用 <code class="xref py py-meth docutils literal notranslate"><span class="pre">apply()</span></code> 进行计算。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [8]: </span><span class="k">def</span><span class="w"> </span><span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="gp">   ...: </span>    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="gp">   ...: </span>    <span class="n">arr</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">   ...: </span>    <span class="k">return</span> <span class="n">arr</span>
<span class="gp">   ...: </span>

<span class="gp">In [9]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]])</span>

<span class="gp">In [10]: </span><span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">"table"</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">weighted_mean</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">"numba"</span><span class="p">)</span>  <span class="c1"># noqa: E501</span>
<span class="gh">Out[10]: </span>
<span class="go">          0         1    2</span>
<span class="go">0  1.000000  2.000000  1.0</span>
<span class="go">1  1.800000  2.000000  1.0</span>
<span class="go">2  3.333333  2.333333  1.0</span>
<span class="go">3  1.555556  7.000000  1.0</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">自 1.3 版本新增。</span></p>
</div>
<p>一些窗口操作还支持在构建窗口对象后使用 <code class="docutils literal notranslate"><span class="pre">online</span></code> 方法，该方法返回一个新对象，支持传入新的 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a> 或 <a class="reference internal" href="../reference/api/pandas.Series.html#pandas.Series" title="pandas.Series"><code class="xref py py-class docutils literal notranslate"><span class="pre">Series</span></code></a> 对象，以继续使用新值进行窗口计算（即在线计算）。</p>
<p>此新窗口对象上的方法必须首先调用聚合方法以“初始化”在线计算的初始状态。然后，可以通过 <code class="docutils literal notranslate"><span class="pre">update</span></code> 参数传入新的 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a> 或 <a class="reference internal" href="../reference/api/pandas.Series.html#pandas.Series" title="pandas.Series"><code class="xref py py-class docutils literal notranslate"><span class="pre">Series</span></code></a> 对象来继续窗口计算。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [11]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]])</span>

<span class="gp">In [12]: </span><span class="n">df</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[12]: </span>
<span class="go">          0         1         2</span>
<span class="go">0  1.000000  2.000000  0.600000</span>
<span class="go">1  1.750000  2.750000  0.450000</span>
<span class="go">2  2.615385  3.615385  0.276923</span>
<span class="go">3  3.550000  4.550000  0.562500</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [13]: </span><span class="n">online_ewm</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">online</span><span class="p">()</span>

<span class="gp">In [14]: </span><span class="n">online_ewm</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[14]: </span>
<span class="go">      0     1     2</span>
<span class="go">0  1.00  2.00  0.60</span>
<span class="go">1  1.75  2.75  0.45</span>

<span class="gp">In [15]: </span><span class="n">online_ewm</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="gh">Out[15]: </span>
<span class="go">          0         1         2</span>
<span class="go">3  3.307692  4.307692  0.623077</span>
</pre></div>
</div>
<p>所有窗口操作都支持 <code class="docutils literal notranslate"><span class="pre">min_periods</span></code> 参数，该参数规定窗口必须包含的非 <code class="docutils literal notranslate"><span class="pre">np.nan</span></code> 值的最小数量；否则，结果值为 <code class="docutils literal notranslate"><span class="pre">np.nan</span></code>。<code class="docutils literal notranslate"><span class="pre">min_periods</span></code> 对于基于时间的窗口默认为 1，对于固定窗口默认为 <code class="docutils literal notranslate"><span class="pre">window</span></code>。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [16]: </span><span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="gp">In [17]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[17]: </span>
<span class="go">0    NaN</span>
<span class="go">1    1.0</span>
<span class="go">2    3.0</span>
<span class="go">3    3.0</span>
<span class="go">4    2.0</span>
<span class="go">5    3.0</span>
<span class="go">dtype: float64</span>

<span class="gp">In [18]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[18]: </span>
<span class="go">0    NaN</span>
<span class="go">1    NaN</span>
<span class="go">2    3.0</span>
<span class="go">3    3.0</span>
<span class="go">4    NaN</span>
<span class="go">5    NaN</span>
<span class="go">dtype: float64</span>

<span class="go"># Equivalent to min_periods=3</span>
<span class="gp">In [19]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[19]: </span>
<span class="go">0   NaN</span>
<span class="go">1   NaN</span>
<span class="go">2   NaN</span>
<span class="go">3   NaN</span>
<span class="go">4   NaN</span>
<span class="go">5   NaN</span>
<span class="go">dtype: float64</span>
</pre></div>
</div>
<p>此外，所有窗口操作都支持 <code class="docutils literal notranslate"><span class="pre">aggregate</span></code> 方法，用于返回应用于窗口的多个聚合结果。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [20]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"A"</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="s2">"B"</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">)})</span>

<span class="gp">In [21]: </span><span class="n">df</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">"sum"</span><span class="p">,</span> <span class="s2">"mean"</span><span class="p">,</span> <span class="s2">"std"</span><span class="p">])</span>
<span class="gh">Out[21]: </span>
<span class="go">      A                    B                </span>
<span class="go">    sum mean       std   sum  mean       std</span>
<span class="go">0   0.0  0.0       NaN  10.0  10.0       NaN</span>
<span class="go">1   1.0  0.5  0.707107  21.0  10.5  0.707107</span>
<span class="go">2   3.0  1.0  1.000000  33.0  11.0  1.000000</span>
<span class="go">3   6.0  1.5  1.290994  46.0  11.5  1.290994</span>
<span class="go">4  10.0  2.0  1.581139  60.0  12.0  1.581139</span>
</pre></div>
</div>
</section>
<section id="rolling-window">
<span id="window-generic"></span><h2>滚动窗口<a class="headerlink" href="window.html#rolling-window" title="Link to this heading">#</a></h2>
<p>通用滚动窗口支持将窗口指定为固定数量的观测值，或根据偏移量指定可变数量的观测值。如果提供了基于时间的偏移量，则相应的基于时间的索引必须是单调的。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [22]: </span><span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'2020-01-01'</span><span class="p">,</span> <span class="s1">'2020-01-03'</span><span class="p">,</span> <span class="s1">'2020-01-04'</span><span class="p">,</span> <span class="s1">'2020-01-05'</span><span class="p">,</span> <span class="s1">'2020-01-29'</span><span class="p">]</span>

<span class="gp">In [23]: </span><span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>

<span class="gp">In [24]: </span><span class="n">s</span>
<span class="gh">Out[24]: </span>
<span class="go">2020-01-01    0</span>
<span class="go">2020-01-03    1</span>
<span class="go">2020-01-04    2</span>
<span class="go">2020-01-05    3</span>
<span class="go">2020-01-29    4</span>
<span class="go">dtype: int64</span>

<span class="go"># Window with 2 observations</span>
<span class="gp">In [25]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[25]: </span>
<span class="go">2020-01-01    NaN</span>
<span class="go">2020-01-03    1.0</span>
<span class="go">2020-01-04    3.0</span>
<span class="go">2020-01-05    5.0</span>
<span class="go">2020-01-29    7.0</span>
<span class="go">dtype: float64</span>

<span class="go"># Window with 2 days worth of observations</span>
<span class="gp">In [26]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="s1">'2D'</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[26]: </span>
<span class="go">2020-01-01    0.0</span>
<span class="go">2020-01-03    1.0</span>
<span class="go">2020-01-04    3.0</span>
<span class="go">2020-01-05    5.0</span>
<span class="go">2020-01-29    4.0</span>
<span class="go">dtype: float64</span>
</pre></div>
</div>
<p>所有支持的聚合函数，请参见<a class="reference internal" href="../reference/window.html#api-functions-rolling"><span class="std std-ref">滚动窗口函数</span></a>。</p>
<section id="centering-windows">
<span id="window-center"></span><h3>居中窗口<a class="headerlink" href="window.html#centering-windows" title="Link to this heading">#</a></h3>
<p>默认情况下，标签设置为窗口的右边缘，但可以使用 <code class="docutils literal notranslate"><span class="pre">center</span></code> 关键字将标签设置为中心。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [27]: </span><span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="gp">In [28]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[28]: </span>
<span class="go">0    NaN</span>
<span class="go">1    NaN</span>
<span class="go">2    NaN</span>
<span class="go">3    NaN</span>
<span class="go">4    2.0</span>
<span class="go">5    3.0</span>
<span class="go">6    4.0</span>
<span class="go">7    5.0</span>
<span class="go">8    6.0</span>
<span class="go">9    7.0</span>
<span class="go">dtype: float64</span>

<span class="gp">In [29]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[29]: </span>
<span class="go">0    NaN</span>
<span class="go">1    NaN</span>
<span class="go">2    2.0</span>
<span class="go">3    3.0</span>
<span class="go">4    4.0</span>
<span class="go">5    5.0</span>
<span class="go">6    6.0</span>
<span class="go">7    7.0</span>
<span class="go">8    NaN</span>
<span class="go">9    NaN</span>
<span class="go">dtype: float64</span>
</pre></div>
</div>
<p>这也可以应用于日期时间类索引。</p>
<div class="versionadded">
<p><span class="versionmodified added">自 1.3.0 版本新增。</span></p>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [30]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<span class="gp">   ....: </span>    <span class="p">{</span><span class="s2">"A"</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]},</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s2">"2020"</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">"1D"</span><span class="p">)</span>
<span class="gp">   ....: </span><span class="p">)</span>
<span class="gp">   ....: </span>

<span class="gp">In [31]: </span><span class="n">df</span>
<span class="gh">Out[31]: </span>
<span class="go">            A</span>
<span class="go">2020-01-01  0</span>
<span class="go">2020-01-02  1</span>
<span class="go">2020-01-03  2</span>
<span class="go">2020-01-04  3</span>
<span class="go">2020-01-05  4</span>

<span class="gp">In [32]: </span><span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s2">"2D"</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[32]: </span>
<span class="go">              A</span>
<span class="go">2020-01-01  0.0</span>
<span class="go">2020-01-02  0.5</span>
<span class="go">2020-01-03  1.5</span>
<span class="go">2020-01-04  2.5</span>
<span class="go">2020-01-05  3.5</span>

<span class="gp">In [33]: </span><span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s2">"2D"</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[33]: </span>
<span class="go">              A</span>
<span class="go">2020-01-01  0.5</span>
<span class="go">2020-01-02  1.5</span>
<span class="go">2020-01-03  2.5</span>
<span class="go">2020-01-04  3.5</span>
<span class="go">2020-01-05  4.0</span>
</pre></div>
</div>
</section>
<section id="rolling-window-endpoints">
<span id="window-endpoints"></span><h3>滚动窗口端点<a class="headerlink" href="window.html#rolling-window-endpoints" title="Link to this heading">#</a></h3>
<p>在滚动窗口计算中是否包含区间端点可以通过 <code class="docutils literal notranslate"><span class="pre">closed</span></code> 参数指定</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>值</p></th>
<th class="head"><p>行为</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">'right'</span></code></p></td>
<td><p>包含右端点</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">'left'</span></code></p></td>
<td><p>包含左端点</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">'both'</span></code></p></td>
<td><p>包含两端点</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">'neither'</span></code></p></td>
<td><p>不包含端点</p></td>
</tr>
</tbody>
</table>
<p>例如，在许多要求当前信息不回溯污染过去信息的问题中，右端点开放会很有用。这允许滚动窗口计算“截至该时间点”的统计数据，但不包括该时间点。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [34]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<span class="gp">   ....: </span>    <span class="p">{</span><span class="s2">"x"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
<span class="gp">   ....: </span>    <span class="n">index</span><span class="o">=</span><span class="p">[</span>
<span class="gp">   ....: </span>        <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"20130101 09:00:01"</span><span class="p">),</span>
<span class="gp">   ....: </span>        <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"20130101 09:00:02"</span><span class="p">),</span>
<span class="gp">   ....: </span>        <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"20130101 09:00:03"</span><span class="p">),</span>
<span class="gp">   ....: </span>        <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"20130101 09:00:04"</span><span class="p">),</span>
<span class="gp">   ....: </span>        <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"20130101 09:00:06"</span><span class="p">),</span>
<span class="gp">   ....: </span>    <span class="p">],</span>
<span class="gp">   ....: </span><span class="p">)</span>
<span class="gp">   ....: </span>

<span class="gp">In [35]: </span><span class="n">df</span><span class="p">[</span><span class="s2">"right"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s2">"2s"</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">"right"</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># default</span>

<span class="gp">In [36]: </span><span class="n">df</span><span class="p">[</span><span class="s2">"both"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s2">"2s"</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">"both"</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="gp">In [37]: </span><span class="n">df</span><span class="p">[</span><span class="s2">"left"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s2">"2s"</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">"left"</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="gp">In [38]: </span><span class="n">df</span><span class="p">[</span><span class="s2">"neither"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s2">"2s"</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s2">"neither"</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="gp">In [39]: </span><span class="n">df</span>
<span class="gh">Out[39]: </span>
<span class="go">                     x  right  both  left  neither</span>
<span class="go">2013-01-01 09:00:01  1    1.0   1.0   NaN      NaN</span>
<span class="go">2013-01-01 09:00:02  1    2.0   2.0   1.0      1.0</span>
<span class="go">2013-01-01 09:00:03  1    2.0   3.0   2.0      1.0</span>
<span class="go">2013-01-01 09:00:04  1    2.0   3.0   2.0      1.0</span>
<span class="go">2013-01-01 09:00:06  1    1.0   2.0   1.0      NaN</span>
</pre></div>
</div>
</section>
<section id="custom-window-rolling">
<span id="window-custom-rolling-window"></span><h3>自定义窗口滚动<a class="headerlink" href="window.html#custom-window-rolling" title="Link to this heading">#</a></h3>
<p>除了接受整数或偏移量作为 <code class="docutils literal notranslate"><span class="pre">window</span></code> 参数外，<code class="docutils literal notranslate"><span class="pre">rolling</span></code> 还接受一个 <code class="docutils literal notranslate"><span class="pre">BaseIndexer</span></code> 子类，允许用户定义计算窗口边界的自定义方法。<code class="docutils literal notranslate"><span class="pre">BaseIndexer</span></code> 子类需要定义一个 <code class="docutils literal notranslate"><span class="pre">get_window_bounds</span></code> 方法，该方法返回一个包含两个数组的元组，第一个数组是窗口的起始索引，第二个数组是窗口的结束索引。此外，<code class="docutils literal notranslate"><span class="pre">num_values</span></code>、<code class="docutils literal notranslate"><span class="pre">min_periods</span></code>、<code class="docutils literal notranslate"><span class="pre">center</span></code>、<code class="docutils literal notranslate"><span class="pre">closed</span></code> 和 <code class="docutils literal notranslate"><span class="pre">step</span></code> 将自动传递给 <code class="docutils literal notranslate"><span class="pre">get_window_bounds</span></code>，并且所定义的方法必须始终接受这些参数。</p>
<p>例如，如果我们有以下 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a></p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [40]: </span><span class="n">use_expanding</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>

<span class="gp">In [41]: </span><span class="n">use_expanding</span>
<span class="gh">Out[41]: </span><span class="go">[True, False, True, False, True]</span>

<span class="gp">In [42]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"values"</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)})</span>

<span class="gp">In [43]: </span><span class="n">df</span>
<span class="gh">Out[43]: </span>
<span class="go">   values</span>
<span class="go">0       0</span>
<span class="go">1       1</span>
<span class="go">2       2</span>
<span class="go">3       3</span>
<span class="go">4       4</span>
</pre></div>
</div>
<p>并且我们希望使用一个扩展窗口，其中 <code class="docutils literal notranslate"><span class="pre">use_expanding</span></code> 为 <code class="docutils literal notranslate"><span class="pre">True</span></code>，否则为大小为 1 的窗口，我们可以创建以下 <code class="docutils literal notranslate"><span class="pre">BaseIndexer</span></code> 子类</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [44]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">pandas.api.indexers</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseIndexer</span>

<span class="gp">In [45]: </span><span class="k">class</span><span class="w"> </span><span class="nc">CustomIndexer</span><span class="p">(</span><span class="n">BaseIndexer</span><span class="p">):</span>
<span class="gp">   ....: </span>     <span class="k">def</span><span class="w"> </span><span class="nf">get_window_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_values</span><span class="p">,</span> <span class="n">min_periods</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">closed</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
<span class="gp">   ....: </span>         <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="gp">   ....: </span>         <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="gp">   ....: </span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_values</span><span class="p">):</span>
<span class="gp">   ....: </span>             <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_expanding</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
<span class="gp">   ....: </span>                 <span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">   ....: </span>                 <span class="n">end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">   ....: </span>             <span class="k">else</span><span class="p">:</span>
<span class="gp">   ....: </span>                 <span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
<span class="gp">   ....: </span>                 <span class="n">end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span>
<span class="gp">   ....: </span>         <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>
<span class="gp">   ....: </span>

<span class="gp">In [46]: </span><span class="n">indexer</span> <span class="o">=</span> <span class="n">CustomIndexer</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_expanding</span><span class="o">=</span><span class="n">use_expanding</span><span class="p">)</span>

<span class="gp">In [47]: </span><span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">indexer</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[47]: </span>
<span class="go">   values</span>
<span class="go">0     0.0</span>
<span class="go">1     1.0</span>
<span class="go">2     3.0</span>
<span class="go">3     3.0</span>
<span class="go">4    10.0</span>
</pre></div>
</div>
<p>您可以在<a class="reference external" href="https://github.com/pandas-dev/pandas/blob/main/pandas/core/indexers/objects.py">此处</a>查看 <code class="docutils literal notranslate"><span class="pre">BaseIndexer</span></code> 子类的其他示例</p>
<p>这些示例中值得注意的一个子类是 <code class="docutils literal notranslate"><span class="pre">VariableOffsetWindowIndexer</span></code>，它允许对非固定偏移量（如 <code class="docutils literal notranslate"><span class="pre">BusinessDay</span></code>）执行滚动操作。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [48]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">pandas.api.indexers</span><span class="w"> </span><span class="kn">import</span> <span class="n">VariableOffsetWindowIndexer</span>

<span class="gp">In [49]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s2">"2020"</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

<span class="gp">In [50]: </span><span class="n">offset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">BDay</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="gp">In [51]: </span><span class="n">indexer</span> <span class="o">=</span> <span class="n">VariableOffsetWindowIndexer</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>

<span class="gp">In [52]: </span><span class="n">df</span>
<span class="gh">Out[52]: </span>
<span class="go">            0</span>
<span class="go">2020-01-01  0</span>
<span class="go">2020-01-02  1</span>
<span class="go">2020-01-03  2</span>
<span class="go">2020-01-04  3</span>
<span class="go">2020-01-05  4</span>
<span class="go">2020-01-06  5</span>
<span class="go">2020-01-07  6</span>
<span class="go">2020-01-08  7</span>
<span class="go">2020-01-09  8</span>
<span class="go">2020-01-10  9</span>

<span class="gp">In [53]: </span><span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">indexer</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[53]: </span>
<span class="go">               0</span>
<span class="go">2020-01-01   0.0</span>
<span class="go">2020-01-02   1.0</span>
<span class="go">2020-01-03   2.0</span>
<span class="go">2020-01-04   3.0</span>
<span class="go">2020-01-05   7.0</span>
<span class="go">2020-01-06  12.0</span>
<span class="go">2020-01-07   6.0</span>
<span class="go">2020-01-08   7.0</span>
<span class="go">2020-01-09   8.0</span>
<span class="go">2020-01-10   9.0</span>
</pre></div>
</div>
<p>对于某些问题，可以获取未来信息进行分析。例如，当每个数据点都是从实验中读取的完整时间序列，并且任务是提取底层条件时，就会出现这种情况。在这些情况下，执行前瞻性滚动窗口计算会很有用。<a class="reference internal" href="../reference/api/pandas.api.indexers.FixedForwardWindowIndexer.html#pandas.api.indexers.FixedForwardWindowIndexer" title="pandas.api.indexers.FixedForwardWindowIndexer"><code class="xref py py-func docutils literal notranslate"><span class="pre">FixedForwardWindowIndexer</span></code></a> 类可用于此目的。此 <a class="reference internal" href="../reference/api/pandas.api.indexers.BaseIndexer.html#pandas.api.indexers.BaseIndexer" title="pandas.api.indexers.BaseIndexer"><code class="xref py py-func docutils literal notranslate"><span class="pre">BaseIndexer</span></code></a> 子类实现了封闭的固定宽度前瞻性滚动窗口，我们可以按如下方式使用它</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [54]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">pandas.api.indexers</span><span class="w"> </span><span class="kn">import</span> <span class="n">FixedForwardWindowIndexer</span>

<span class="gp">In [55]: </span><span class="n">indexer</span> <span class="o">=</span> <span class="n">FixedForwardWindowIndexer</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="gp">In [56]: </span><span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">indexer</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gh">Out[56]: </span>
<span class="go">               0</span>
<span class="go">2020-01-01   1.0</span>
<span class="go">2020-01-02   3.0</span>
<span class="go">2020-01-03   5.0</span>
<span class="go">2020-01-04   7.0</span>
<span class="go">2020-01-05   9.0</span>
<span class="go">2020-01-06  11.0</span>
<span class="go">2020-01-07  13.0</span>
<span class="go">2020-01-08  15.0</span>
<span class="go">2020-01-09  17.0</span>
<span class="go">2020-01-10   9.0</span>
</pre></div>
</div>
<p>我们还可以通过切片、应用滚动聚合，然后翻转结果来实现这一点，如下例所示</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [57]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<span class="gp">   ....: </span>    <span class="n">data</span><span class="o">=</span><span class="p">[</span>
<span class="gp">   ....: </span>        <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"2018-01-01 00:00:00"</span><span class="p">),</span> <span class="mi">100</span><span class="p">],</span>
<span class="gp">   ....: </span>        <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"2018-01-01 00:00:01"</span><span class="p">),</span> <span class="mi">101</span><span class="p">],</span>
<span class="gp">   ....: </span>        <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"2018-01-01 00:00:03"</span><span class="p">),</span> <span class="mi">103</span><span class="p">],</span>
<span class="gp">   ....: </span>        <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">"2018-01-01 00:00:04"</span><span class="p">),</span> <span class="mi">111</span><span class="p">],</span>
<span class="gp">   ....: </span>    <span class="p">],</span>
<span class="gp">   ....: </span>    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"time"</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">],</span>
<span class="gp">   ....: </span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">"time"</span><span class="p">)</span>
<span class="gp">   ....: </span>

<span class="gp">In [58]: </span><span class="n">df</span>
<span class="gh">Out[58]: </span>
<span class="go">                     value</span>
<span class="go">time                      </span>
<span class="go">2018-01-01 00:00:00    100</span>
<span class="go">2018-01-01 00:00:01    101</span>
<span class="go">2018-01-01 00:00:03    103</span>
<span class="go">2018-01-01 00:00:04    111</span>

<span class="gp">In [59]: </span><span class="n">reversed_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s2">"2s"</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="gp">In [60]: </span><span class="n">reversed_df</span>
<span class="gh">Out[60]: </span>
<span class="go">                     value</span>
<span class="go">time                      </span>
<span class="go">2018-01-01 00:00:00  201.0</span>
<span class="go">2018-01-01 00:00:01  101.0</span>
<span class="go">2018-01-01 00:00:03  214.0</span>
<span class="go">2018-01-01 00:00:04  111.0</span>
</pre></div>
</div>
</section>
<section id="rolling-apply">
<span id="window-rolling-apply"></span><h3>滚动应用 (Rolling apply)<a class="headerlink" href="window.html#rolling-apply" title="Link to this heading">#</a></h3>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">apply()</span></code> 函数接受一个额外的 <code class="docutils literal notranslate"><span class="pre">func</span></code> 参数并执行通用滚动计算。<code class="docutils literal notranslate"><span class="pre">func</span></code> 参数应该是一个从 ndarray 输入生成单个值的函数。<code class="docutils literal notranslate"><span class="pre">raw</span></code> 指定窗口是转换为 <a class="reference internal" href="../reference/api/pandas.Series.html#pandas.Series" title="pandas.Series"><code class="xref py py-class docutils literal notranslate"><span class="pre">Series</span></code></a> 对象 (<code class="docutils literal notranslate"><span class="pre">raw=False</span></code>) 还是 ndarray 对象 (<code class="docutils literal notranslate"><span class="pre">raw=True</span></code>)。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [61]: </span><span class="k">def</span><span class="w"> </span><span class="nf">mad</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="gp">   ....: </span>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gp">   ....: </span>

<span class="gp">In [62]: </span><span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="gp">In [63]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">mad</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gh">Out[63]: </span>
<span class="go">0    NaN</span>
<span class="go">1    NaN</span>
<span class="go">2    NaN</span>
<span class="go">3    1.0</span>
<span class="go">4    1.0</span>
<span class="go">5    1.0</span>
<span class="go">6    1.0</span>
<span class="go">7    1.0</span>
<span class="go">8    1.0</span>
<span class="go">9    1.0</span>
<span class="go">dtype: float64</span>
</pre></div>
</div>
</section>
<section id="numba-engine">
<span id="window-numba-engine"></span><h3>Numba 引擎<a class="headerlink" href="window.html#numba-engine" title="Link to this heading">#</a></h3>
<p>此外，如果 <a class="reference external" href="https://numba.pydata.org.cn/">Numba</a> 作为可选依赖项安装，<code class="xref py py-meth docutils literal notranslate"><span class="pre">apply()</span></code> 可以利用它。通过指定 <code class="docutils literal notranslate"><span class="pre">engine='numba'</span></code> 和 <code class="docutils literal notranslate"><span class="pre">engine_kwargs</span></code> 参数（<code class="docutils literal notranslate"><span class="pre">raw</span></code> 也必须设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code>），可以使用 Numba 执行应用聚合。有关参数的通用用法和性能考量，请参见<a class="reference internal" href="enhancingperf.html#enhancingperf-numba"><span class="std std-ref">使用 Numba 提升性能</span></a>。</p>
<p>Numba 可能在两个例程中应用</p>
<ol class="arabic simple">
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">func</span></code> 是标准 Python 函数，引擎将对传入函数进行 <a class="reference external" href="https://numba.pydata.org.cn/numba-doc/latest/user/overview.html">JIT 编译</a>。<code class="docutils literal notranslate"><span class="pre">func</span></code> 也可以是已 JIT 编译的函数，在这种情况下引擎不会再次对其进行 JIT 编译。</p></li>
<li><p>引擎将对循环（应用函数应用于每个窗口）进行 JIT 编译。</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">engine_kwargs</span></code> argument is a dictionary of keyword arguments that will be passed into the <a class="reference external" href="https://numba.pydata.org.cn/numba-doc/latest/reference/jit-compilation.html#numba.jit">numba.jit decorator</a>. These keyword arguments will be applied to <em>both</em> the passed function (if a standard Python function) and the apply for loop over each window.</p>
<div class="versionadded">
<p><span class="versionmodified added">自 1.3.0 版本新增。</span></p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mean</span></code>、<code class="docutils literal notranslate"><span class="pre">median</span></code>、<code class="docutils literal notranslate"><span class="pre">max</span></code>、<code class="docutils literal notranslate"><span class="pre">min</span></code> 和 <code class="docutils literal notranslate"><span class="pre">sum</span></code> 也支持 <code class="docutils literal notranslate"><span class="pre">engine</span></code> 和 <code class="docutils literal notranslate"><span class="pre">engine_kwargs</span></code> 参数。</p>
</section>
<section id="binary-window-functions">
<span id="window-cov-corr"></span><h3>二元窗口函数<a class="headerlink" href="window.html#binary-window-functions" title="Link to this heading">#</a></h3>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">cov()</span></code> 和 <code class="xref py py-meth docutils literal notranslate"><span class="pre">corr()</span></code> 可以计算关于两个 <a class="reference internal" href="../reference/api/pandas.Series.html#pandas.Series" title="pandas.Series"><code class="xref py py-class docutils literal notranslate"><span class="pre">Series</span></code></a> 或任意组合的 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a>/<a class="reference internal" href="../reference/api/pandas.Series.html#pandas.Series" title="pandas.Series"><code class="xref py py-class docutils literal notranslate"><span class="pre">Series</span></code></a> 或 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a>/<a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a> 的移动窗口统计量。以下是每种情况的行为</p>
<ul class="simple">
<li><p>两个 <a class="reference internal" href="../reference/api/pandas.Series.html#pandas.Series" title="pandas.Series"><code class="xref py py-class docutils literal notranslate"><span class="pre">Series</span></code></a>: 计算配对的统计量。</p></li>
<li><p><a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a>/<a class="reference internal" href="../reference/api/pandas.Series.html#pandas.Series" title="pandas.Series"><code class="xref py py-class docutils literal notranslate"><span class="pre">Series</span></code></a>: 计算 DataFrame 的每一列与传入 Series 的统计量，返回一个 DataFrame。</p></li>
<li><p><a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a>/<a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a>: 默认计算匹配列名的统计量，返回一个 DataFrame。如果传入关键字参数 <code class="docutils literal notranslate"><span class="pre">pairwise=True</span></code>，则计算每对列的统计量，返回一个带有 <a class="reference internal" href="../reference/api/pandas.MultiIndex.html#pandas.MultiIndex" title="pandas.MultiIndex"><code class="xref py py-class docutils literal notranslate"><span class="pre">MultiIndex</span></code></a> 的 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a>，其值是相关日期（请参见<a class="reference internal" href="window.html#window-corr-pairwise"><span class="std std-ref">下一节</span></a>）。</p></li>
</ul>
<p>例如</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [64]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<span class="gp">   ....: </span>    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="gp">   ....: </span>    <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s2">"2020-01-01"</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
<span class="gp">   ....: </span>    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"A"</span><span class="p">,</span> <span class="s2">"B"</span><span class="p">,</span> <span class="s2">"C"</span><span class="p">,</span> <span class="s2">"D"</span><span class="p">],</span>
<span class="gp">   ....: </span><span class="p">)</span>
<span class="gp">   ....: </span>

<span class="gp">In [65]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

<span class="gp">In [66]: </span><span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>

<span class="gp">In [67]: </span><span class="n">df2</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">"B"</span><span class="p">])</span>
<span class="gh">Out[67]: </span>
<span class="go">              A    B    C    D</span>
<span class="go">2020-01-01  NaN  NaN  NaN  NaN</span>
<span class="go">2020-01-02 -1.0  1.0 -1.0  1.0</span>
<span class="go">2020-01-03  1.0  1.0  1.0 -1.0</span>
<span class="go">2020-01-04 -1.0  1.0  1.0 -1.0</span>
</pre></div>
</div>
</section>
<section id="computing-rolling-pairwise-covariances-and-correlations">
<span id="window-corr-pairwise"></span><h3>计算滚动成对协方差和相关性<a class="headerlink" href="window.html#computing-rolling-pairwise-covariances-and-correlations" title="Link to this heading">#</a></h3>
<p>在金融数据分析和其他领域，计算时间序列集合的协方差和相关矩阵很常见。通常，人们也对移动窗口协方差和相关矩阵感兴趣。这可以通过传入 <code class="docutils literal notranslate"><span class="pre">pairwise</span></code> 关键字参数来完成，对于 <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a> 输入，这将产生一个 MultiIndexed <a class="reference internal" href="../reference/api/pandas.DataFrame.html#pandas.DataFrame" title="pandas.DataFrame"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataFrame</span></code></a>，其 <code class="docutils literal notranslate"><span class="pre">index</span></code> 是相关日期。在单个 DataFrame 参数的情况下，甚至可以省略 <code class="docutils literal notranslate"><span class="pre">pairwise</span></code> 参数。</p>
<div class="admonition note">
<p class="admonition-title">注意</p>
<p>缺失值将被忽略，每个条目都使用成对完整观测值进行计算。</p>
<p>假设缺失数据是随机缺失的，这将得到一个无偏的协方差矩阵估计。然而，对于许多应用而言，此估计可能不可接受，因为估计的协方差矩阵不保证是半正定的。这可能导致估计的相关系数的绝对值大于一，和/或一个不可逆的协方差矩阵。有关更多详细信息，请参见<a class="reference external" href="https://en.wikipedia.org/w/index.php?title=Estimation_of_covariance_matrices">协方差矩阵估计</a>。</p>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [68]: </span><span class="n">covs</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">   ....: </span>    <span class="n">df</span><span class="p">[[</span><span class="s2">"B"</span><span class="p">,</span> <span class="s2">"C"</span><span class="p">,</span> <span class="s2">"D"</span><span class="p">]]</span>
<span class="gp">   ....: </span>    <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="gp">   ....: </span>    <span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">"A"</span><span class="p">,</span> <span class="s2">"B"</span><span class="p">,</span> <span class="s2">"C"</span><span class="p">]],</span> <span class="n">pairwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">   ....: </span><span class="p">)</span>
<span class="gp">   ....: </span>

<span class="gp">In [69]: </span><span class="n">covs</span>
<span class="gh">Out[69]: </span>
<span class="go">                     B         C         D</span>
<span class="go">2020-01-01 A       NaN       NaN       NaN</span>
<span class="go">           B       NaN       NaN       NaN</span>
<span class="go">           C       NaN       NaN       NaN</span>
<span class="go">2020-01-02 A       NaN       NaN       NaN</span>
<span class="go">           B       NaN       NaN       NaN</span>
<span class="go">...                ...       ...       ...</span>
<span class="go">2020-01-09 B  0.342006  0.230190  0.052849</span>
<span class="go">           C  0.230190  1.575251  0.082901</span>
<span class="go">2020-01-10 A -0.333945  0.006871 -0.655514</span>
<span class="go">           B  0.649711  0.430860  0.469271</span>
<span class="go">           C  0.430860  0.829721  0.055300</span>

<span class="go">[30 rows x 3 columns]</span>
</pre></div>
</div>
</section>
</section>
<section id="weighted-window">
<span id="window-weighted"></span><h2>加权窗口<a class="headerlink" href="window.html#weighted-window" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">.rolling</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">win_type</span></code> 参数生成加权窗口，这些窗口常用于滤波和频谱估计。<code class="docutils literal notranslate"><span class="pre">win_type</span></code> 必须是与 <a class="reference external" href="https://docs.scipy.org.cn/doc/scipy/reference/signal.windows.html#module-scipy.signal.windows">scipy.signal 窗口函数</a>对应的字符串。必须安装 Scipy 才能使用这些窗口，并且 Scipy 窗口方法接受的补充参数必须在聚合函数中指定。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [70]: </span><span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="gp">In [71]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[71]: </span>
<span class="go">0    NaN</span>
<span class="go">1    NaN</span>
<span class="go">2    NaN</span>
<span class="go">3    NaN</span>
<span class="go">4    2.0</span>
<span class="go">5    3.0</span>
<span class="go">6    4.0</span>
<span class="go">7    5.0</span>
<span class="go">8    6.0</span>
<span class="go">9    7.0</span>
<span class="go">dtype: float64</span>

<span class="gp">In [72]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">win_type</span><span class="o">=</span><span class="s2">"triang"</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[72]: </span>
<span class="go">0    NaN</span>
<span class="go">1    NaN</span>
<span class="go">2    NaN</span>
<span class="go">3    NaN</span>
<span class="go">4    2.0</span>
<span class="go">5    3.0</span>
<span class="go">6    4.0</span>
<span class="go">7    5.0</span>
<span class="go">8    6.0</span>
<span class="go">9    7.0</span>
<span class="go">dtype: float64</span>

<span class="go"># Supplementary Scipy arguments passed in the aggregation function</span>
<span class="gp">In [73]: </span><span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">win_type</span><span class="o">=</span><span class="s2">"gaussian"</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="gh">Out[73]: </span>
<span class="go">0    NaN</span>
<span class="go">1    NaN</span>
<span class="go">2    NaN</span>
<span class="go">3    NaN</span>
<span class="go">4    2.0</span>
<span class="go">5    3.0</span>
<span class="go">6    4.0</span>
<span class="go">7    5.0</span>
<span class="go">8    6.0</span>
<span class="go">9    7.0</span>
<span class="go">dtype: float64</span>
</pre></div>
</div>
<p>所有支持的聚合函数，请参见<a class="reference internal" href="../reference/window.html#api-functions-window"><span class="std std-ref">加权窗口函数</span></a>。</p>
</section>
<section id="expanding-window">
<span id="window-expanding"></span><h2>扩展窗口<a class="headerlink" href="window.html#expanding-window" title="Link to this heading">#</a></h2>
<p>扩展窗口会生成截至该时间点所有可用数据的聚合统计值。由于这些计算是滚动统计的一种特殊情况，它们在 pandas 中的实现使得以下两种调用是等效的</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [74]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="gp">In [75]: </span><span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[75]: </span>
<span class="go">     0</span>
<span class="go">0  0.0</span>
<span class="go">1  0.5</span>
<span class="go">2  1.0</span>
<span class="go">3  1.5</span>
<span class="go">4  2.0</span>

<span class="gp">In [76]: </span><span class="n">df</span><span class="o">.</span><span class="n">expanding</span><span class="p">(</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[76]: </span>
<span class="go">     0</span>
<span class="go">0  0.0</span>
<span class="go">1  0.5</span>
<span class="go">2  1.0</span>
<span class="go">3  1.5</span>
<span class="go">4  2.0</span>
</pre></div>
</div>
<p>所有支持的聚合函数，请参见<a class="reference internal" href="../reference/window.html#api-functions-expanding"><span class="std std-ref">扩展窗口函数</span></a>。</p>
</section>
<section id="exponentially-weighted-window">
<span id="window-exponentially-weighted"></span><h2>指数加权窗口<a class="headerlink" href="window.html#exponentially-weighted-window" title="Link to this heading">#</a></h2>
<p>指数加权窗口类似于扩展窗口，但每个先前点相对于当前点都会进行指数加权衰减。</p>
<p>一般来说，加权移动平均值计算如下</p>
<div class="math notranslate nohighlight">\[y_t = \frac{\sum_{i=0}^t w_i x_{t-i}}{\sum_{i=0}^t w_i},\]</div>
<p>其中 <span class="math notranslate nohighlight">\(x_t\)</span> 是输入，<span class="math notranslate nohighlight">\(y_t\)</span> 是结果，<span class="math notranslate nohighlight">\(w_i\)</span> 是权重。</p>
<p>所有支持的聚合函数，请参见<a class="reference internal" href="../reference/window.html#api-functions-ewm"><span class="std std-ref">指数加权窗口函数</span></a>。</p>
<p>EW 函数支持两种指数权重变体。默认情况下，<code class="docutils literal notranslate"><span class="pre">adjust=True</span></code> 使用权重 <span class="math notranslate nohighlight">\(w_i = (1 - \alpha)^i\)</span>，得到</p>
<div class="math notranslate nohighlight">\[y_t = \frac{x_t + (1 - \alpha)x_{t-1} + (1 - \alpha)^2 x_{t-2} + ... + (1 - \alpha)^t x_{0}}{1 + (1 - \alpha) + (1 - \alpha)^2 + ... + (1 - \alpha)^t}\]</div>
<p>当指定 <code class="docutils literal notranslate"><span class="pre">adjust=False</span></code> 时，移动平均值计算如下</p>
<div class="math notranslate nohighlight">\[\begin{split}y_0 &amp;= x_0 \\ y_t &amp;= (1 - \alpha) y_{t-1} + \alpha x_t,\end{split}\]</div>
<p>这等价于使用权重</p>
<div class="math notranslate nohighlight">\[\begin{split}w_i = \begin{cases} \alpha (1 - \alpha)^i &amp; \text{if } i &lt; t \\ (1 - \alpha)^i &amp; \text{if } i = t. \end{cases}\end{split}\]</div>
<div class="admonition note">
<p class="admonition-title">注意</p>
<p>这些方程有时用 <span class="math notranslate nohighlight">\(\alpha' = 1 - \alpha\)</span> 来表示，例如</p>
<div class="math notranslate nohighlight">\[y_t = \alpha' y_{t-1} + (1 - \alpha') x_t.\]</div>
</div>
<p>上述两种变体之间的差异产生是因为我们处理的是具有有限历史的序列。考虑一个具有无限历史的序列，当 <code class="docutils literal notranslate"><span class="pre">adjust=True</span></code> 时</p>
<div class="math notranslate nohighlight">\[y_t = \frac{x_t + (1 - \alpha)x_{t-1} + (1 - \alpha)^2 x_{t-2} + ...} {1 + (1 - \alpha) + (1 - \alpha)^2 + ...}\]</div>
<p>注意到分母是首项为 1、公比为 <span class="math notranslate nohighlight">\(1 - \alpha\)</span> 的几何级数，我们得到</p>
<div class="math notranslate nohighlight">\[\begin{split}y_t &amp;= \frac{x_t + (1 - \alpha)x_{t-1} + (1 - \alpha)^2 x_{t-2} + ...} {\frac{1}{1 - (1 - \alpha)}}\\ &amp;= [x_t + (1 - \alpha)x_{t-1} + (1 - \alpha)^2 x_{t-2} + ...] \alpha \\ &amp;= \alpha x_t + [(1-\alpha)x_{t-1} + (1 - \alpha)^2 x_{t-2} + ...]\alpha \\ &amp;= \alpha x_t + (1 - \alpha)[x_{t-1} + (1 - \alpha) x_{t-2} + ...]\alpha\\ &amp;= \alpha x_t + (1 - \alpha) y_{t-1}\end{split}\]</div>
<p>这与上述 <code class="docutils literal notranslate"><span class="pre">adjust=False</span></code> 的表达式相同，因此显示了这两种变体对于无限序列的等效性。当 <code class="docutils literal notranslate"><span class="pre">adjust=False</span></code> 时，我们有 <span class="math notranslate nohighlight">\(y_0 = x_0\)</span> 和 <span class="math notranslate nohighlight">\(y_t = \alpha x_t + (1 - \alpha) y_{t-1}\)</span>。因此，存在一个假设，即 <span class="math notranslate nohighlight">\(x_0\)</span> 不是一个普通值，而是无限序列截至该点的指数加权矩。</p>
<p>必须满足 <span class="math notranslate nohighlight">\(0 &lt; \alpha \leq 1\)</span>，虽然可以直接传入 <span class="math notranslate nohighlight">\(\alpha\)</span>，但通常更容易从 EW 矩的 **span**、**质心 (com)** 或 **半衰期** 来考虑</p>
<div class="math notranslate nohighlight">\[\begin{split}\alpha = \begin{cases} \frac{2}{s + 1}, &amp; \text{for span}\ s \geq 1\\ \frac{1}{1 + c}, &amp; \text{for center of mass}\ c \geq 0\\ 1 - \exp^{\frac{\log 0.5}{h}}, &amp; \text{for half-life}\ h > 0 \end{cases}\end{split}\]</div>
<p>必须且只能向 EW 函数指定 **span**、**质心**、**半衰期** 和 **alpha** 中的一个</p>
<ul class="simple">
<li><p>**Span** 对应于通常所说的“N 天 EW 移动平均”。</p></li>
<li><p>**质心 (Center of mass)** 具有更物理的解释，可以从 span 的角度来考虑：<span class="math notranslate nohighlight">\(c = (s - 1) / 2\)</span>。</p></li>
<li><p>**半衰期 (Half-life)** 是指数权重衰减到一半所需的时间周期。</p></li>
<li><p>**Alpha** 直接指定平滑因子。</p></li>
</ul>
<p>您还可以将 <code class="docutils literal notranslate"><span class="pre">halflife</span></code> 指定为可转换为时间差的单位，以指定观测值衰减到其值一半所需的时间，同时也要指定 <code class="docutils literal notranslate"><span class="pre">times</span></code> 序列。</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [77]: </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"B"</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">4</span><span class="p">]})</span>

<span class="gp">In [78]: </span><span class="n">df</span>
<span class="gh">Out[78]: </span>
<span class="go">     B</span>
<span class="go">0  0.0</span>
<span class="go">1  1.0</span>
<span class="go">2  2.0</span>
<span class="go">3  NaN</span>
<span class="go">4  4.0</span>

<span class="gp">In [79]: </span><span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"2020-01-01"</span><span class="p">,</span> <span class="s2">"2020-01-03"</span><span class="p">,</span> <span class="s2">"2020-01-10"</span><span class="p">,</span> <span class="s2">"2020-01-15"</span><span class="p">,</span> <span class="s2">"2020-01-17"</span><span class="p">]</span>

<span class="gp">In [80]: </span><span class="n">df</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">halflife</span><span class="o">=</span><span class="s2">"4 days"</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">times</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="gh">Out[80]: </span>
<span class="go">          B</span>
<span class="go">0  0.000000</span>
<span class="go">1  0.585786</span>
<span class="go">2  1.523889</span>
<span class="go">3  1.523889</span>
<span class="go">4  3.233686</span>
</pre></div>
</div>
<p>以下公式用于计算带有时间输入向量的指数加权平均值</p>
<div class="math notranslate nohighlight">\[y_t = \frac{\sum_{i=0}^t 0.5^\frac{t_{t} - t_{i}}{\lambda} x_{t-i}}{\sum_{i=0}^t 0.5^\frac{t_{t} - t_{i}}{\lambda}},\]</div>
<p>ExponentialMovingWindow 还有一个 <code class="docutils literal notranslate"><span class="pre">ignore_na</span></code> 参数，它决定了中间空值如何影响权重的计算。当 <code class="docutils literal notranslate"><span class="pre">ignore_na=False</span></code>（默认值）时，权重根据绝对位置计算，因此中间空值会影响结果。当 <code class="docutils literal notranslate"><span class="pre">ignore_na=True</span></code> 时，权重通过忽略中间空值来计算。例如，假设 <code class="docutils literal notranslate"><span class="pre">adjust=True</span></code>，如果 <code class="docutils literal notranslate"><span class="pre">ignore_na=False</span></code>，则 <code class="docutils literal notranslate"><span class="pre">3,</span> <span class="pre">NaN,</span> <span class="pre">5</span></code> 的加权平均值将计算为</p>
<div class="math notranslate nohighlight">\[\frac{(1-\alpha)^2 \cdot 3 + 1 \cdot 5}{(1-\alpha)^2 + 1}.\]</div>
<p>而如果 <code class="docutils literal notranslate"><span class="pre">ignore_na=True</span></code>，加权平均值将计算为</p>
<div class="math notranslate nohighlight">\[\frac{(1-\alpha) \cdot 3 + 1 \cdot 5}{(1-\alpha) + 1}.\]</div>
<p><code class="xref py py-meth docutils literal notranslate"><span class="pre">var()</span></code>、<code class="xref py py-meth docutils literal notranslate"><span class="pre">std()</span></code> 和 <code class="xref py py-meth docutils literal notranslate"><span class="pre">cov()</span></code> 函数有一个 <code class="docutils literal notranslate"><span class="pre">bias</span></code> 参数，用于指定结果应包含有偏还是无偏统计量。例如，如果 <code class="docutils literal notranslate"><span class="pre">bias=True</span></code>，<code class="docutils literal notranslate"><span class="pre">ewmvar(x)</span></code> 计算为 <code class="docutils literal notranslate"><span class="pre">ewmvar(x)</span> <span class="pre">=</span> <span class="pre">ewma(x**2)</span> <span class="pre">-</span> <span class="pre">ewma(x)**2</span></code>；而如果 <code class="docutils literal notranslate"><span class="pre">bias=False</span></code>（默认值），有偏方差统计量将通过去偏因子进行缩放</p>
<div class="math notranslate nohighlight">\[\frac{\left(\sum_{i=0}^t w_i\right)^2}{\left(\sum_{i=0}^t w_i\right)^2 - \sum_{i=0}^t w_i^2}.\]</div>
<p>（对于 <span class="math notranslate nohighlight">\(w_i = 1\)</span>，这会简化为通常的 <span class="math notranslate nohighlight">\(N / (N - 1)\)</span> 因子，其中 <span class="math notranslate nohighlight">\(N = t + 1\)</span>。）有关更多详细信息，请参见维基百科上的<a class="reference external" href="https://en.wikipedia.org/wiki/Weighted_arithmetic_mean#Weighted_sample_variance">加权样本方差</a>。</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev" href="groupby.html" title="previous page"> <i class="fa-solid fa-angle-left"></i> <div class="prev-next-info"> <p class="prev-next-subtitle">上一页</p> <p class="prev-next-title">Group by: 分割-应用-组合</p> </div> </a> <a class="right-next" href="timeseries.html" title="next page"> <div class="prev-next-info"> <p class="prev-next-subtitle">下一页</p> <p class="prev-next-title">时间序列 / 日期功能</p> </div> <i class="fa-solid fa-angle-right"></i> </a></div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">

  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> 在此页上</div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#overview">概述</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#rolling-window">滚动窗口</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#centering-windows">居中窗口</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#rolling-window-endpoints">滚动窗口端点</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#custom-window-rolling">自定义窗口滚动</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#rolling-apply">滚动应用</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#numba-engine">Numba 引擎</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#binary-window-functions">二元窗口函数</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#computing-rolling-pairwise-covariances-and-correlations">计算滚动成对协方差和相关性</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#weighted-window">加权窗口</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#expanding-window">扩展窗口</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="window.html#exponentially-weighted-window">指数加权窗口</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/user_guide/window.rst.txt">
      <i class="fa-solid fa-file-lines"></i> 显示源代码</a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js%3Fdigest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js%3Fdigest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item"><p class="copyright">© 2025, pandas 通过 <a href="https://numfocus.org">NumFOCUS, Inc.</a>。由 <a href="https://www.ovhcloud.com">OVHcloud</a> 托管。</p></div>
      
        <div class="footer-item">

  <p class="sphinx-version">使用 <a href="https://sphinx-doc.cn/">Sphinx</a> 8.1.3 创建。<br />
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">使用 <a href="https://pydata.sphinx-doc.cn/en/stable/index.html">PyData Sphinx Theme</a> 0.14.4 构建。</p></div>
      
    </div>
  
</div>

  </footer>
  
</body></html>